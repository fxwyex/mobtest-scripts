// ==UserScript==
// @name         QOL changes (RUBY)
// @namespace    http://tampermonkey.net/
// @version      1.1.0
// @description  try to take over the world!
// @author       You
// @include      /^https:\/\/r.*a.*tech\/?/
// @updateURL    https://raw.githubusercontent.com/fxwyex/mobtest-scripts/refs/heads/main/public/QOLchanges.txt
// @downloadURL  https://raw.githubusercontent.com/fxwyex/mobtest-scripts/refs/heads/main/public/QOLchanges.txt
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant              GM_getValue
// @grant              GM_setValue
// @grant              GM.getValue
// @grant              GM.setValue
// @grant GM.listValues
// @grant GM_listValues
// @grant GM.deleteValue
// @grant GM_deleteValue
// @grant GM_addStyle
// ==/UserScript==

(function() {
    'use strict';
    let _G = unsafeWindow.tmScripts;
    let reducedGaps = _G.getValue("var_qol_reduced_gaps", true)
    let showOnlyFailed = _G.getValue("var_qol_show_only_failed", false)
    let gapSize = (_G.getValue("var_gap_size_px", 1) + "px")
    let scrollToView = _G.getValue("var_qol_scroll_to_view", true)
    let MapStorage = _G.getValue("var_qol_map_storage_cdw_view", false)
    let MapStorageDS = _G.getValue("var_qol_map_ds_cdw_view", false)
    let loaded = false;
    let focused = null;
    let isActive = false;
    const textboxSelector = '#itemIdentifier';
    function applyGaps(gSize) {
        let ele0 = document.querySelector(".device-info-card__content");
        let ele1 = document.querySelector(".job-order-details");
        let ele2 = document.querySelector(".diagnostic-data__content");
        let ele3 = document.querySelector(".cdw-results__content");
        let ele4 = document.querySelector(".retested-data__content");
        let ele5 = document.querySelector("app-generic-provider")
        if (ele0) {
            document.querySelectorAll("form").forEach((index) => {
                index.style.gap = gSize;
            });
        }
        ele1 ? (ele1.style.gap = gSize) : false;
        ele2 ? (ele2.style.gap = gSize) : false;
        ele3 ? (ele3.style.gap = gSize) : false;
        ele4 ? (ele4.style.gap = gSize) : false;
        if (ele5) {
            ele5.children[0].classList.remove("gap-3")
            ele5.children[0].style.gap = gSize
        }
    }



    const mainLoop = function() {
        let test2 = document.querySelector(".diagnostic-data__content");
        if (reducedGaps == true) {
            applyGaps(gapSize);
        }
        if (showOnlyFailed) {
            document.querySelector("app-device-diagnostic-data")?.querySelectorAll(".text-success-emphasis")?.forEach(item => {
                item.parentElement.parentElement.remove()
            })
        }
    }
    let group;
    const mainUICreate = function() {
        const targetNode = document.querySelector(".layout__main");
        group = _G.createSettingsGroup("QOL Settings")

        _G.createSettingToggleButton(group, "Reduced Gaps", "var_qol_reduced_gaps", function() {
            reducedGaps = _G.getValue("var_qol_reduced_gaps", true)
            if (reducedGaps == false) {
                applyGaps("16px");
            }
            if (reducedGaps == true) {
                applyGaps(gapSize);
            }
        }, true)
        _G.createSettingInput(group, "Gap Size", "px","number", "var_gap_size_px", function() {
            gapSize = (_G.getValue("var_gap_size_px", 1) + "px")
            if (reducedGaps == true) {
                applyGaps(gapSize);
            }
        })
        _G.createSettingToggleButton(group, "Only Show Failed CDW Tests", "var_qol_show_only_failed", function() {
            showOnlyFailed = _G.getValue("var_qol_show_only_failed", false)
        }, false)
         _G.createSettingToggleButton(group, "Auto Scroll Retail Form to View", "var_qol_scroll_to_view", function() {
            scrollToView = _G.getValue("var_qol_scroll_to_view", true)
        }, false)
         _G.createSettingToggleButton(group, "CDW Auto Select Product Name", "var_qol_map_storage_cdw_view", function() {
            MapStorage = _G.getValue("var_qol_map_storage_cdw_view", false)
        }, true)
         _G.createSettingToggleButton(group, "CDW Auto Select DS", "var_qol_map_ds_cdw_view", function() {
            MapStorageDS = _G.getValue("var_qol_map_ds_cdw_view", false)
        }, true)
        _G.showToast({title: "TamperMonkey",message: "QOL Stuff (RUBY) Loaded",messageType: "info"})
    }

    const menuStatusUpdate = () => {
        _G.updateGroupState(group, "_idQOLUpdate")
    }
    const autoScrollToView = () => {
        if (scrollToView) {
            document.querySelector("app-gradingform").scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
        }
    }

    var css = `
.ng-option.ng-option-marked {
        background-color: #717171 !important;
        color: #ffffff !important;
    }
`;
    GM_addStyle(css);
    async function waitOneFrame() {
        return new Promise((resolve) => {
            requestAnimationFrame(() => resolve());
        });
    }
    let autoChecked = false; //true if the dropdown was opened by the automapper
    async function dostuff2() {
        if (MapStorageDS) {
            await waitOneFrame()
            let list = document.querySelector("app-item-name-field > app-form-field > div > div > div.control > div > ng-select > ng-dropdown-panel > div > div.scrollable-content")?.children
            if (!list) return;
            let count = 0;
            let count2 = 0;
            Array.from(list).forEach(thing => {
                if (thing.innerText.endsWith(" DS")) {count++;}
            })
            if (count != 1) return; //more than 1 or None DS
            document.querySelector("app-device-diagnostic-data")?.querySelectorAll("app-list-row")?.forEach(item => {
                if (item.textContent.includes("IMEI/Serial Number")) {
                    let input = item.querySelector("div > div.col-md-8.custom-scrollbar.overflow-x-auto.fw-strong > ul")
                    input.innerText.split("\n").forEach(item => {
                        if (item.match(/^\d{15}$/gm)) {
                            count2++;
                        }
                    })
                }
            })
            if (count2 != 2) return; //1 or more than 2 IMEIs
            Array.from(list).forEach(thing => {
                if (thing.innerText.endsWith(" DS")) {
                    thing.dispatchEvent(new Event("click"))
                }
            })
        }
    }
    const autoMapStorage = () => {
       if (MapStorage) {
            setTimeout(() => {
                document.querySelector("#name").onclick = function () {
                    autoChecked = false;
                }
                document.querySelector("app-device-diagnostic-data")?.querySelectorAll("app-list-row")?.forEach(item => {
                    if (item.textContent.includes("Disks")) {
                        let input = document.querySelector("#name")
                        if (input) {
                            input.value = item.textContent.replace("Disks","")
                            input.dispatchEvent(new Event("input"));
                            input.focus()
                            autoChecked = true
                        }
                        return;
                    }
                })
            }, 0);

        }
    }
    const autoMapDS = () => {
        setTimeout(() => {dostuff2()}, 500); //looks better with this imo
    }
    _G.bind({onCreate: mainUICreate, search: "app-sidebar", id: "_idQOLCreateMenu", href: ["*"]})
    _G.bind({onUpdate: menuStatusUpdate, search: "app-root", id: "_idQOLMenuStatus", href: ["*"]})
    _G.bind({onUpdate: mainLoop, search: ".layout__main", id: "_idQOLUpdate", href: ["*"]})
    _G.bind({onCreate: autoScrollToView, search: "app-gradingform", id: "_idQOLAutoScrollToView", href: ["de158ff49a8d4545a72da9ba1bdf65e67d0635fbc73a386199ea467c40638ca2","478d3f8b27adf42ee22b001ab35ec6ea87ac500a26a40e127f54ef62f4df2bda","f2513d2b767348c06ad7b5ef42f30a5cdb30ccac9529184331edbe7f601985bb"]})
    _G.bind({onCreate: autoMapStorage, search: "app-provider-data > app-generic-provider > div > app-label-row", id: "_idQOLAutoLinkStorageFromCDW", href: ["de158ff49a8d4545a72da9ba1bdf65e67d0635fbc73a386199ea467c40638ca2","478d3f8b27adf42ee22b001ab35ec6ea87ac500a26a40e127f54ef62f4df2bda","f2513d2b767348c06ad7b5ef42f30a5cdb30ccac9529184331edbe7f601985bb"]})
     _G.bind({onCreate: autoMapDS, onUpdate: autoMapDS, search: "app-item-name-field > app-form-field > div > div > div.control > div > ng-select > ng-dropdown-panel > div > div.scrollable-content", id: "_idQOLAutoLinkStorageFromDS", href: ["de158ff49a8d4545a72da9ba1bdf65e67d0635fbc73a386199ea467c40638ca2","478d3f8b27adf42ee22b001ab35ec6ea87ac500a26a40e127f54ef62f4df2bda","f2513d2b767348c06ad7b5ef42f30a5cdb30ccac9529184331edbe7f601985bb"]})
})();




